{% extends 'base.html' %}
{% load static %}

{% block title %}SST - {% if object %}Editar{% else %}Nueva{% endif %} Inspección de Procesos{% endblock %}

{% block extra_head %}
<!-- Reuse existing styles -->
<style>
    .inspection-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f2f5;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        outline: none;
    }

    .item-table {
        width: 100%;
        border-collapse: collapse;
    }

    .item-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-light);
        border-bottom: 2px solid #dee2e6;
    }

    .item-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }

    .status-select {
        min-width: 120px;
    }

    .obs-input {
        width: 100%;
        min-height: 60px;
    }
</style>
{% endblock %}

{% block header_title %}Inspecciones de Seguridad - Instalaciones de Proceso{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px; padding: 20px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 1.8rem; font-weight: 700; color: var(--text-color); margin-bottom: 4px;">
                {% if object %}Editar{% else %}Nueva{% endif %} Inspección de Proceso
            </h1>
            <p style="color: var(--text-light); margin: 0;">Formato R-RH-SST-030</p>
        </div>
        <a href="{% url 'process_list' %}" class="btn btn-secondary"
            style="background: white; border: 1px solid #dee2e6; color: var(--text-color);">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Render hidden fields (like area) -->
        {% for field in form.hidden_fields %}
        {{ field }}
        {% endfor %}

        <!-- General Data Card -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-info-circle"></i> Datos Generales</h3>

            <div class="form-grid">
                <!-- Inspection Date -->
                <div class="form-group">
                    <label>Fecha de Inspección</label>
                    {{ form.inspection_date }}
                    {% if form.inspection_date.errors %}
                    <div class="text-danger small">{{ form.inspection_date.errors }}</div>
                    {% endif %}
                </div>

                <!-- Inspector Role -->
                <div class="form-group">
                    <label>Rol del Inspector</label>
                    {{ form.inspector_role }}
                    {% if form.inspector_role.errors %}
                    <div class="text-danger small">{{ form.inspector_role.errors }}</div>
                    {% endif %}
                </div>

                <!-- Inspected Process -->
                <div class="form-group">
                    <label>Proceso Inspeccionado</label>
                    {{ form.inspected_process }}
                    {% if form.inspected_process.errors %}
                    <div class="text-danger small">{{ form.inspected_process.errors }}</div>
                    {% endif %}
                </div>

                <!-- Render other visible fields dynamically (e.g., area if visible) -->
                {% for field in form.visible_fields %}
                {% if field.name != 'inspection_date' and field.name != 'inspector_role' and field.name != 'inspected_process' and field.name != 'additional_observations' %}
                <div class="form-group">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                    <div class="text-danger small">{{ field.errors }}</div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- If there are other visible fields not manually rendered, show them here (excluding additional_observations which goes at the end) -->
        </div>

        <!-- Items Checklist -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-tasks"></i> Lista de Verificación</h3>
            {{ items.management_form }}

            {% if items.non_form_errors %}
            <div class="alert alert-danger">{{ items.non_form_errors }}</div>
            {% endif %}

            <div style="overflow-x: auto;">
                <table class="item-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Ítem a Evaluar</th>
                            <th style="width: 15%;">Cumple</th>
                            <th style="width: 15%;">Estado</th>
                            <th style="width: 30%;">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item_form in items %}
                        {{ item_form.id }}
                        <tr>
                            <td>
                                {{ item_form.question }}
                            </td>
                            <td>
                                {{ item_form.response }}
                                {% if item_form.response.errors %}
                                <div class="text-danger small">{{ item_form.response.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.item_status }}
                                {% if item_form.item_status.errors %}
                                <div class="text-danger small">{{ item_form.item_status.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.observations }}
                                {% if item_form.observations.errors %}
                                <div class="text-danger small">{{ item_form.observations.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Additional Observations -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-comment-alt"></i> Observaciones Adicionales</h3>
            <div class="form-group">
                {{ form.additional_observations }}
                {% if form.additional_observations.errors %}
                <div class="text-danger small">{{ form.additional_observations.errors }}</div>
                {% endif %}
                <small class="text-muted">Cualquier otra observación relevante que no esté cubierta en los ítems
                    anteriores.</small>
            </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
            <a href="{% url 'process_list' %}" class="btn btn-light"
                style="background: white; border: 1px solid #dee2e6;">Cancelar</a>
            <button type="submit" class="btn btn-primary" style="padding: 10px 24px; font-weight: 500;">
                <i class="fas fa-save"></i> Guardar Inspección
            </button>
        </div>
    </form>
</div>

<script>
    (function () {

        // --- Banner de error inline (reemplaza alert()) ---
        function showValidationBanner(messages) {
            let banner = document.getElementById('js-validation-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'js-validation-banner';
                banner.style.cssText = [
                    'position:fixed', 'top:20px', 'right:20px', 'z-index:9999',
                    'max-width:380px', 'background:#fff',
                    'border-left:4px solid #dc3545', 'border-radius:8px',
                    'box-shadow:0 4px 16px rgba(0,0,0,0.12)',
                    'padding:14px 16px', 'font-size:0.9rem', 'color:#333'
                ].join(';');
                document.body.appendChild(banner);
            }
            const listItems = messages.map(m => `<li style="margin-bottom:4px;">${m}</li>`).join('');
            banner.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                    <div>
                        <div style="font-weight:600;color:#dc3545;margin-bottom:6px;">
                            <i class="fas fa-exclamation-circle"></i> Por favor corrija los siguientes errores:
                        </div>
                        <ul style="margin:0;padding-left:18px;color:#555;">${listItems}</ul>
                    </div>
                    <button onclick="document.getElementById('js-validation-banner').remove()"
                        style="background:none;border:none;cursor:pointer;color:#aaa;font-size:1.2rem;padding:0;line-height:1;">&times;</button>
                </div>`;
            clearTimeout(banner._timer);
            banner._timer = setTimeout(() => { if (banner.parentNode) banner.remove(); }, 8000);
        }

        function validateForm(event) {
            let hasError = false;
            let firstErrorInput = null;
            const errorMessages = [];

            // --- Validar campo Proceso Inspeccionado ---
            const processInput = document.querySelector('input[name="inspected_process"], textarea[name="inspected_process"]');
            if (processInput) {
                const processErrorId = 'js-process-error';
                if (processInput.value.trim() === '') {
                    hasError = true;
                    errorMessages.push('El campo <strong>Proceso Inspeccionado</strong> es obligatorio.');
                    processInput.style.border = '2px solid #dc3545';
                    processInput.style.backgroundColor = '#fff8f8';
                    if (!document.getElementById(processErrorId)) {
                        const errorDiv = document.createElement('div');
                        errorDiv.id = processErrorId;
                        errorDiv.className = 'text-danger small';
                        errorDiv.style.cssText = 'font-weight:600;margin-top:4px;';
                        errorDiv.innerText = 'Este campo es obligatorio.';
                        processInput.parentNode.appendChild(errorDiv);
                    }
                    if (!firstErrorInput) firstErrorInput = processInput;
                } else {
                    processInput.style.border = '';
                    processInput.style.backgroundColor = '';
                    const existingError = document.getElementById(processErrorId);
                    if (existingError) existingError.remove();
                }
            }

            // --- Validar ítems con estado Malo sin observación ---
            let maloSinObs = 0;
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(function (row) {
                let statusSelect = row.querySelector('select[name*="item_status"]') || row.querySelector('select');
                let obsInput = row.querySelector('textarea[name*="observations"]') || row.querySelector('textarea');
                if (statusSelect && obsInput) {
                    const status = statusSelect.value;
                    const obs = obsInput.value.trim();
                    if (status === 'Malo' && obs === '') {
                        hasError = true;
                        maloSinObs++;
                        obsInput.style.border = '2px solid #dc3545';
                        obsInput.style.backgroundColor = '#fff8f8';
                        let errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                        if (!errorDiv) {
                            errorDiv = document.createElement('div');
                            errorDiv.className = 'text-danger small js-strict-error';
                            errorDiv.style.cssText = 'font-weight:600;margin-top:4px;';
                            errorDiv.innerText = 'Debe ingresar una observación para ítems en estado "Malo".';
                            obsInput.parentNode.appendChild(errorDiv);
                        }
                        if (!firstErrorInput) firstErrorInput = obsInput;
                    } else {
                        obsInput.style.border = '';
                        obsInput.style.backgroundColor = '';
                        const errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                        if (errorDiv) errorDiv.remove();
                    }
                }
            });

            if (maloSinObs > 0) {
                errorMessages.push(`${maloSinObs} ítem(s) marcado(s) como <strong>"Malo"</strong> sin observación registrada.`);
            }

            if (hasError) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
                showValidationBanner(errorMessages);
                if (firstErrorInput) {
                    firstErrorInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstErrorInput.focus();
                }
                return false;
            }

            return true;
        }

        document.addEventListener('submit', function (e) {
            if (e.target.tagName === 'FORM') {
                if (!validateForm(e)) e.preventDefault();
            }
        }, true);

        document.addEventListener('change', function (e) {
            const target = e.target;
            if (target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') {
                const row = target.closest('tr');
                if (row) {
                    const statusSelect = row.querySelector('select[name*="item_status"]') || row.querySelector('select');
                    const obsInput = row.querySelector('textarea[name*="observations"]') || row.querySelector('textarea');
                    if (statusSelect && obsInput) {
                        if (statusSelect.value !== 'Malo' || obsInput.value.trim() !== '') {
                            obsInput.style.border = '';
                            obsInput.style.backgroundColor = '';
                            const errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                            if (errorDiv) errorDiv.remove();
                        }
                    }
                }
            }
        }, true);

        // Limpiar error del campo proceso al escribir
        document.addEventListener('input', function (e) {
            if (e.target.name === 'inspected_process' && e.target.value.trim() !== '') {
                e.target.style.border = '';
                e.target.style.backgroundColor = '';
                const err = document.getElementById('js-process-error');
                if (err) err.remove();
            }
        }, true);

    })();
</script>
{% endblock %}