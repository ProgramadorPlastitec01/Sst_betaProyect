{% extends 'base.html' %}
{% load static %}

{% block title %}SST - {% if object %}Editar{% else %}Nueva{% endif %} Inspección de Procesos{% endblock %}

{% block extra_head %}
<!-- Reuse existing styles -->
<style>
    .inspection-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        padding: 24px;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f2f5;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        outline: none;
    }

    .item-table {
        width: 100%;
        border-collapse: collapse;
    }

    .item-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-light);
        border-bottom: 2px solid #dee2e6;
    }

    .item-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }

    .status-select {
        min-width: 120px;
    }

    .obs-input {
        width: 100%;
        min-height: 60px;
    }
</style>
{% endblock %}

{% block header_title %}Inspecciones de Seguridad - Instalaciones de Proceso{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px; padding: 20px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 1.8rem; font-weight: 700; color: var(--text-color); margin-bottom: 4px;">
                {% if object %}Editar{% else %}Nueva{% endif %} Inspección de Proceso
            </h1>
            <p style="color: var(--text-light); margin: 0;">Formato R-RH-SST-030</p>
        </div>
        <a href="{% url 'process_list' %}" class="btn btn-secondary"
            style="background: white; border: 1px solid #dee2e6; color: var(--text-color);">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Render hidden fields (like area) -->
        {% for field in form.hidden_fields %}
        {{ field }}
        {% endfor %}

        <!-- General Data Card -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-info-circle"></i> Datos Generales</h3>

            <div class="form-grid">
                <!-- Inspection Date -->
                <div class="form-group">
                    <label>Fecha de Inspección</label>
                    {{ form.inspection_date }}
                    {% if form.inspection_date.errors %}
                    <div class="text-danger small">{{ form.inspection_date.errors }}</div>
                    {% endif %}
                </div>

                <!-- Inspector Role -->
                <div class="form-group">
                    <label>Rol del Inspector</label>
                    {{ form.inspector_role }}
                    {% if form.inspector_role.errors %}
                    <div class="text-danger small">{{ form.inspector_role.errors }}</div>
                    {% endif %}
                </div>

                <!-- Inspected Process -->
                <div class="form-group">
                    <label>Proceso Inspeccionado</label>
                    {{ form.inspected_process }}
                    {% if form.inspected_process.errors %}
                    <div class="text-danger small">{{ form.inspected_process.errors }}</div>
                    {% endif %}
                </div>

                <!-- Render other visible fields dynamically (e.g., area if visible) -->
                {% for field in form.visible_fields %}
                {% if field.name != 'inspection_date' and field.name != 'inspector_role' and field.name != 'inspected_process' and field.name != 'additional_observations' %}
                <div class="form-group">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                    <div class="text-danger small">{{ field.errors }}</div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- If there are other visible fields not manually rendered, show them here (excluding additional_observations which goes at the end) -->
        </div>

        <!-- Items Checklist -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-tasks"></i> Lista de Verificación</h3>
            {{ items.management_form }}

            {% if items.non_form_errors %}
            <div class="alert alert-danger">{{ items.non_form_errors }}</div>
            {% endif %}

            <div style="overflow-x: auto;">
                <table class="item-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Ítem a Evaluar</th>
                            <th style="width: 15%;">Cumple</th>
                            <th style="width: 15%;">Estado</th>
                            <th style="width: 30%;">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item_form in items %}
                        {{ item_form.id }}
                        <tr>
                            <td>
                                {{ item_form.question }}
                            </td>
                            <td>
                                {{ item_form.response }}
                                {% if item_form.response.errors %}
                                <div class="text-danger small">{{ item_form.response.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.item_status }}
                                {% if item_form.item_status.errors %}
                                <div class="text-danger small">{{ item_form.item_status.errors }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.observations }}
                                {% if item_form.observations.errors %}
                                <div class="text-danger small">{{ item_form.observations.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Additional Observations -->
        <div class="inspection-card">
            <h3 class="section-title"><i class="fas fa-comment-alt"></i> Observaciones Adicionales</h3>
            <div class="form-group">
                {{ form.additional_observations }}
                {% if form.additional_observations.errors %}
                <div class="text-danger small">{{ form.additional_observations.errors }}</div>
                {% endif %}
                <small class="text-muted">Cualquier otra observación relevante que no esté cubierta en los ítems
                    anteriores.</small>
            </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
            <a href="{% url 'process_list' %}" class="btn btn-light"
                style="background: white; border: 1px solid #dee2e6;">Cancelar</a>
            <button type="submit" class="btn btn-primary" style="padding: 10px 24px; font-weight: 500;">
                <i class="fas fa-save"></i> Guardar Inspección
            </button>
        </div>
    </form>
</div>

<script>
    (function () {
        console.log("Inicializando validación estricta de inspección...");

        function validateForm(event) {
            console.log("Validando formulario...");
            let hasError = false;
            let firstErrorInput = null;
            let errorCount = 0;

            // Selectores universales para mayor robustez
            const rows = document.querySelectorAll('tbody tr');

            rows.forEach(function (row, index) {
                // Buscamos selects y textareas en la fila
                // Asumimos que el primer select es el estado y el primer textarea es la observación
                // O buscamos por coincidencia parcial de nombre si existen atributos name
                let statusSelect = row.querySelector('select[name*="item_status"]');
                let obsInput = row.querySelector('textarea[name*="observations"]');

                if (!statusSelect) statusSelect = row.querySelector('select'); // Fallback
                if (!obsInput) obsInput = row.querySelector('textarea'); // Fallback

                // Verificamos si es una fila válida con ambos controles
                if (statusSelect && obsInput) {
                    const status = statusSelect.value;
                    const obs = obsInput.value.trim();

                    if (status === 'Malo') {
                        if (obs === '') {
                            console.error(`ERROR en Fila ${index}: Malo sin observación.`);
                            hasError = true;
                            errorCount++;

                            // Estilos de error visuales fuertes
                            obsInput.style.border = '2px solid #dc3545';
                            obsInput.style.backgroundColor = '#fff8f8';

                            // Mensaje de error
                            let errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                            if (!errorDiv) {
                                errorDiv = document.createElement('div');
                                errorDiv.className = 'text-danger small js-strict-error';
                                errorDiv.style.fontWeight = 'bold';
                                errorDiv.style.marginTop = '4px';
                                errorDiv.innerText = 'Debe ingresar una observación en el ítem marcado como "Malo".';
                                obsInput.parentNode.appendChild(errorDiv);
                            }

                            if (!firstErrorInput) firstErrorInput = obsInput;
                        } else {
                            // Limpiar error si se corrige
                            obsInput.style.border = '';
                            obsInput.style.backgroundColor = '';
                            const errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                            if (errorDiv) errorDiv.remove();
                        }
                    } else {
                        // Limpiar error si cambia estado
                        obsInput.style.border = '';
                        obsInput.style.backgroundColor = '';
                        const errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                        if (errorDiv) errorDiv.remove();
                    }
                }
            });

            if (hasError) {
                console.error(`Validación fallida: ${errorCount} errores encontrados.`);
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();

                alert('Existen ítems en estado "Malo" sin observación. Por favor complete la información antes de continuar.');

                if (firstErrorInput) {
                    firstErrorInput.focus();
                    firstErrorInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                return false;
            }

            console.log("Validación exitosa, enviando formulario.");
            return true;
        }

        // Usamos captura (tercer argumento true) para interceptar el evento antes que nadie
        document.addEventListener('submit', function (e) {
            const form = e.target;
            // Verificar si el target es un formulario (o si el evento burbujeó desde un submit inside form, pero submit dispara en form)
            if (form.tagName === 'FORM') {
                if (!validateForm(e)) {
                    e.preventDefault();
                }
            }
        }, true); // useCapture = true

        // Limpiar errores en tiempo real
        document.addEventListener('change', function (e) {
            const target = e.target;
            if (target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') {
                const row = target.closest('tr');
                if (row) {
                    const statusSelect = row.querySelector('select');
                    const obsInput = row.querySelector('textarea');

                    if (statusSelect && obsInput) {
                        if (statusSelect.value !== 'Malo' || obsInput.value.trim() !== '') {
                            obsInput.style.border = '';
                            obsInput.style.backgroundColor = '';
                            const errorDiv = obsInput.parentNode.querySelector('.js-strict-error');
                            if (errorDiv) errorDiv.remove();
                        }
                    }
                }
            }
        }, true); // Use capture para change event también por seguridad

        console.log("Sistema de validación estricta activado (Modo Captura).");

    })();
</script>
{% endblock %}