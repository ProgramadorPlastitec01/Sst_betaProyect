{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes Históricos - SST System{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .reports-container {
        padding: 20px;
    }

    .filter-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        border: 1px solid #e5e7eb;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 1200px) {
        .filter-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        align-items: center;
        border-top: 1px solid #f3f4f6;
        padding-top: 20px;
        margin-top: 5px;
    }

    .form-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #4b5563;
    }

    .form-control {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .report-stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s;
    }

    .report-stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .icon-blue {
        background: #eff6ff;
        color: #3b82f6;
    }

    .icon-green {
        background: #f0fdf4;
        color: #22c55e;
    }

    .icon-yellow {
        background: #fefce8;
        color: #eab308;
    }

    .icon-purple {
        background: #faf5ff;
        color: #a855f7;
    }

    .icon-orange {
        background: #fff7ed;
        color: #f97316;
    }

    .icon-red {
        background: #fef2f2;
        color: #ef4444;
    }

    .stat-val {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 500;
        margin: 0;
    }

    .chart-section {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 25px;
    }

    .data-card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .report-table th {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
    }

    .report-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }

    .report-table tr:hover {
        background: #fefefe;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-success {
        background: #dcfce7;
        color: #166534;
    }

    .badge-warning {
        background: #fef9c3;
        color: #854d0e;
    }

    .badge-info {
        background: #e0f2fe;
        color: #075985;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-export {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }

    .btn-export:hover {
        background: #059669;
    }

    .btn-sst {
        background: #49BAA0;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: filter 0.2s;
    }

    .btn-sst:hover {
        filter: brightness(0.9);
        color: white;
    }
</style>
{% endblock %}

{% block header_title %}Módulo de Reportes e Históricos{% endblock %}

{% block content %}
<div class="reports-container">
    <div class="filter-card">
        <form method="GET" action="{% url 'inspection_reports' %}" id="filter-form">
            <div class="filter-grid">
                <div class="form-group">
                    <label>Año</label>
                    <select name="year" class="form-control" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        {% for y in years_data %}
                        <option value="{{ y }}" {% if request.GET.year == y|stringformat:"i" %}selected{% endif %}>{{ y }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group"><label>Desde</label><input type="date" name="start_date" class="form-control"
                        value="{{ request.GET.start_date }}"></div>
                <div class="form-group"><label>Hasta</label><input type="date" name="end_date" class="form-control"
                        value="{{ request.GET.end_date }}"></div>
                <div class="form-group">
                    <label>Área</label>
                    <select name="area" class="form-control">
                        <option value="">Todas las Áreas</option>
                        {% for area in areas %}
                        <option value="{{ area.id }}" {% if request.GET.area == area.id|stringformat:"s"%}selected{%endif%}>
                            {{ area.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de Inspección</label>
                    <select name="type" class="form-control">
                        <option value="">Todos los Tipos</option>
                        {% for t in types %}
                        <option value="{{ t }}" {% if request.GET.type == t %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select name="status" class="form-control">
                        <option value="">Todos los Estados</option>
                        {% for s in statuses %}
                        <option value="{{ s }}" {% if request.GET.status == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Responsable</label>
                    <select name="responsible" class="form-control">
                        <option value="">Todos</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if request.GET.responsible == user.id|stringformat:"s"%}selected{% endif %}>
                            {{ user.get_full_name|default:user.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Participante</label>
                    <select name="participant" class="form-control">
                        <option value="">Todos</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if request.GET.participant == user.id|stringformat:"s"%}selected{% endif %}>
                            {{ user.get_full_name|default:user.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <a href="{% url 'inspection_reports' %}" class="btn btn-secondary"
                    style="text-decoration: none;">Limpiar</a>
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                <button type="button" class="btn-export" onclick="exportExcel()"><i class="fas fa-file-excel"></i>
                    Exportar</button>
            </div>
        </form>
    </div>

    <div class="stats-grid">
        <div class="report-stat-card">
            <div class="stat-icon icon-blue"><i class="fas fa-clipboard-list"></i></div>
            <div>
                <p class="stat-val">{{ stats.programmed }}</p>
                <p class="stat-label">Programadas</p>
            </div>
        </div>
        <div class="report-stat-card">
            <div class="stat-icon icon-green"><i class="fas fa-check-double"></i></div>
            <div>
                <p class="stat-val">{{ stats.closed }}</p>
                <p class="stat-label">Cerradas</p>
            </div>
        </div>
        <div class="report-stat-card">
            <div class="stat-icon icon-yellow"><i class="fas fa-clock"></i></div>
            <div>
                <p class="stat-val">{{ stats.pending }}</p>
                <p class="stat-label">Pendientes</p>
            </div>
        </div>
        <div class="report-stat-card">
            <div class="stat-icon icon-red"><i class="fas fa-exclamation-triangle"></i></div>
            <div>
                <p class="stat-val">{{ stats.overdue }}</p>
                <p class="stat-label">Vencidas</p>
            </div>
        </div>
    </div>

    <div class="chart-section">
        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 20px; color: #374151;">Comparativa Mensual de
            Inspecciones ({% firstof request.GET.year "2026" %})</h3>
        <div style="height: 350px; width: 100%; position: relative;"><canvas id="trendChart"></canvas></div>

        <!-- Indicador de filtro activo desde el gráfico -->
        <div id="chart-filter-bar" style="display:none; margin-top:16px; padding:10px 16px; background:#eff6ff;
                    border:1px solid #bfdbfe; border-radius:8px;
                    display:none; align-items:center; gap:12px; font-size:.875rem; color:#1d4ed8;">
            <i class="fas fa-filter"></i>
            <span id="chart-filter-label">Filtrando por…</span>
            <button onclick="clearChartFilter()" style="margin-left:auto; background:#dbeafe; border:none; color:#1d4ed8;
                           padding:4px 12px; border-radius:6px; cursor:pointer; font-size:.8rem;
                           font-weight:600; display:flex; align-items:center; gap:6px;">
                <i class="fas fa-times"></i> Quitar filtro
            </button>
        </div>
    </div>

    <div class="data-card">
        <div class="table-responsive">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo de Inspección</th>
                        <th>Área</th>
                        <th>Fecha Prog.</th>
                        <th>Fecha Exec.</th>
                        <th>Estado</th>
                        <th>Responsable / Participantes</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in consolidated %}
                    <tr>
                        <td style="font-weight: 700; color: #49BAA0;">{{ item.id }}</td>
                        <td style="font-weight: 500;">{{ item.type }}</td>
                        <td>{{ item.area }}</td>
                        <td style="color: #6B7280;">{{ item.date_prog|date:"d/m/Y"|default:"-" }}</td>
                        <td style="font-weight: 600; color: #374151;">{{ item.date_exec|date:"d/m/Y"|default:"-" }}</td>
                        <td><span
                                class="badge {% if 'Cerrada' in item.status %}badge-success{% elif 'Pendiente' in item.status or 'Programada' in item.status %}badge-warning{% elif 'proceso' in item.status %}badge-info{% else %}badge-secondary{% endif %}">
                                {{ item.status }}</span>

                        </td>
                        <td>
                            <div style="font-weight: 600; font-size: 0.85rem; color: #111827;">{{ item.responsible }}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                title="{{ item.participants }}">{{ item.participants }}</div>
                        </td>
                        <td>{% if item.detail_url %}<a href="{{ item.detail_url }}" class="btn-sst"><i
                                    class="fas fa-eye"></i> Detalle</a>{% else %}<span
                                style="color: #cbd5e1; font-size: 0.8rem;">Sin registro</span>{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">No se encontraron
                            inspecciones con los filtros aplicados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function exportExcel() {
        const form = document.getElementById('filter-form');
        const params = new URLSearchParams(new FormData(form)).toString();
        window.location.href = "{% url 'inspection_reports_export' %}?" + params;
    }

    // ── Meses del gráfico → nombres para comparar con texto de celdas ───
    const MONTH_NAMES_ES = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];

    // ── Estado activo del filtro de gráfico ─────────────────────────────
    let chartFilter = { active: false, monthIdx: null, dataset: null };

    // ── Todas las filas de la tabla (capturadas al cargar) ───────────────
    let _allRows = null;
    function getAllRows() {
        if (!_allRows) _allRows = Array.from(document.querySelectorAll('.report-table tbody tr'));
        return _allRows;
    }

    // Mapeo: etiqueta del dataset → palabras clave en la columna Estado (índice 5)
    const DATASET_STATUS_MAP = {
        'Cerradas': ['cerrada'],                   // cerrada / cerrada con hallazgos
        'Pendientes': ['programada', 'pendiente por ejecutar'],  // sin registro, fecha futura
        'Vencidas': ['vencida']                    // sin registro, fecha pasada
    };

    function applyChartFilter() {
        if (!chartFilter.active) { clearChartFilter(); return; }

        const monthIdx = chartFilter.monthIdx;   // 0-11
        const dataset = chartFilter.dataset;    // 'Ejecutadas' | 'Cerradas' | 'Pendientes'
        const keywords = DATASET_STATUS_MAP[dataset] || [];

        // Columna 3 = Fecha Prog., columna 4 = Fecha Exec.
        // Usamos el mes/año de cualquiera de las dos fechas
        const yearFilter = document.querySelector('select[name="year"]')?.value || '';

        let visibleCount = 0;
        getAllRows().forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 6) { row.style.display = ''; return; } // fila vacía / colspan

            const dateProg = cells[3]?.textContent?.trim() || '';
            const dateExec = cells[4]?.textContent?.trim() || '';
            const statusTxt = cells[5]?.textContent?.trim().toLowerCase() || '';

            // Detectar mes a partir de cualquiera de las dos fechas (formato d/m/Y o -)
            function extractMonth(dateStr) {
                const parts = dateStr.split('/');
                return parts.length  ==  3 ? parseInt(parts[1], 10) - 1 : null; // 0-indexed
            }
            const mProg = extractMonth(dateProg);
            const mExec = extractMonth(dateExec);
            const rowMonth = mExec != null ? mExec : mProg;

            // También considerar el año si hay filtro de año activo en el form
            let yearOk = true;
            if (yearFilter) {
                function extractYear(dateStr) {
                    const parts = dateStr.split('/');
                    return parts.length  ==  3 ? parts[2] : null;
                }
                const yProg = extractYear(dateProg);
                const yExec = extractYear(dateExec);
                yearOk = yExec  ==  yearFilter || yProg  ==  yearFilter;
            }

            const monthOk = rowMonth  ==  monthIdx;
            const statusOk = keywords.some(k => statusTxt.includes(k));

            if (monthOk && statusOk && yearOk) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Mostrar mensaje si 0 resultados
        const noResultRow = document.getElementById('chart-no-result-row');
        if (noResultRow) noResultRow.style.display = visibleCount  ==  0 ? '' : 'none';
    }

    function clearChartFilter() {
        chartFilter = { active: false, monthIdx: null, dataset: null };
        getAllRows().forEach(r => r.style.display = '');
        const bar = document.getElementById('chart-filter-bar');
        bar.style.display = 'none';
        const noResultRow = document.getElementById('chart-no-result-row');
        if (noResultRow) noResultRow.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Agregar fila de "Sin resultados tras filtro de gráfico"
        const tbody = document.querySelector('.report-table tbody');
        if (tbody) {
            const nr = document.createElement('tr');
            nr.id = 'chart-no-result-row';
            nr.style.display = 'none';
            nr.innerHTML = '<td colspan="8" style="text-align:center;padding:32px;color:#6b7280;">'
                + '<i class="fas fa-chart-bar" style="margin-right:8px;"></i>'
                + 'No hay registros que coincidan con el segmento seleccionado en el gráfico.</td>';
            tbody.appendChild(nr);
        }

        const chartEl = document.getElementById('trendChart');
        if (!chartEl) return;
        const ctx = chartEl.getContext('2d');
        const reportLabels = {{ trend_data.labels| safe }};
    const reportCerr = {{ trend_data.cerradas| safe }};
    const reportPend = {{ trend_data.pendientes| safe }};
    const reportVenc = {{ trend_data.vencidas| safe }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: reportLabels,
            datasets: [
                { label: 'Cerradas', backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgb(16, 185, 129)', borderWidth: 1, data: reportCerr, borderRadius: 4 },
                { label: 'Pendientes', type: 'line', borderColor: 'rgb(245, 158, 11)', backgroundColor: 'rgb(245, 158, 11)', borderWidth: 3, fill: false, data: reportPend, tension: 0.3, pointRadius: 4, pointHoverRadius: 6 },
                { label: 'Vencidas', backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgb(239, 68, 68)', borderWidth: 1, data: reportVenc, borderRadius: 4 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            // ── Cursor pointer sobre las barras ──
            onHover: (event, elements) => {
                chartEl.style.cursor = elements.length ? 'pointer' : 'default';
            },
            // ── Click handler: filtrar tabla ──
            onClick: (event, elements) => {
                if (!elements || elements.length  ==  0) return;
                const el = elements[0];
                const monthIdx = el.index;           // 0-11
                const datasetIdx = el.datasetIndex;    // 0=Cerr, 1=Pend(line), 2=Venc
                const datasetNames = ['Cerradas', 'Pendientes', 'Vencidas'];
                const datasetName = datasetNames[datasetIdx];
                const monthName = MONTH_NAMES_ES[monthIdx];

                // Actualizar estado del filtro
                chartFilter = { active: true, monthIdx: monthIdx, dataset: datasetName };

                // Mostrar barra de indicador
                const bar = document.getElementById('chart-filter-bar');
                document.getElementById('chart-filter-label').textContent =
                    `${datasetName} · ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
                bar.style.display = 'flex';

                // Aplicar filtro a la tabla
                applyChartFilter();

                // Scroll suave hacia la tabla
                document.querySelector('.data-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            },
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 20, font: { family: "'Inter', sans-serif", size: 12 } } },
                tooltip: { mode: 'index', intersect: false, padding: 12, backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#111827', bodyColor: '#4b5563', borderColor: '#e5e7eb', borderWidth: 1, usePointStyle: true }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#f3f4f6' } },
                x: { grid: { display: false }, ticks: { font: { size: 11 } } }
            }
        }
    });
    });
</script>
{% endblock %}