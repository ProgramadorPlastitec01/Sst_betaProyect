{% extends 'base.html' %}
{% load static %}

{% block title %}Reporte Inspección #{{ object.pk }}{% endblock %}

{% block content %}
<div class="report-container"
    style="background: white; max-width: 1000px; margin: 0 auto; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">

    <!-- Cabecera del Reporte -->
    <div
        style="border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin: 0; font-size: 24px; color: #333;">REPORTE DE INSPECCIÓN DE EXTINTORES</h1>
            <p style="margin: 5px 0 0; color: #666;">Código: R-RH-SST-019</p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 14px; font-weight: bold; color: #333;">N° Inspección: #{{ object.pk }}</div>
            <div style="font-size: 14px; color: #666;">{{ object.inspection_date|date:"d/m/Y" }}</div>
        </div>
    </div>

    <!-- Información General -->
    <div
        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; background: #f9f9f9; padding: 20px; border-radius: 4px; border: 1px solid #eee;">
        <div>
            <label
                style="display: block; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase;">Área
                / Ubicación</label>
            <div style="font-size: 16px; font-weight: 600; color: #333;">{{ object.area }}</div>
        </div>
        <div>
            <label
                style="display: block; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase;">Responsable</label>
            <div style="font-size: 16px; font-weight: 600; color: #333;">
                {{ object.inspector.get_full_name|default:object.inspector }}</div>
            <span style="font-size: 12px; color: #666;">{{ object.inspector_role }}</span>
        </div>
        <div>
            <label
                style="display: block; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase;">Estado
                General</label>
            <span class="badge"
                style="background-color:{% if object.status == 'Cerrada' %}#28a745{% elif object.status == 'Cerrada con Hallazgos' %}#ffc107{% elif object.status == 'En proceso' %}#007bff{% elif object.status == 'Programada' %}#6c757d{% else %}#6c757d{% endif %}; color:white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                {{ object.status|upper }}
            </span>
        </div>
        {% if object.observations %}
        <div style="grid-column: 1 / -1; margin-top: 10px;">
            <label
                style="display: block; font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase;">Observaciones
                Generales</label>
            <div style="font-size: 14px; color: #333; font-style: italic;">{{ object.observations }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Tabla Detallada -->
    <div style="margin-bottom: 40px;">
        <h3 style="font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">DETALLE
            DE EXTINTORES</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
                <tr style="background-color: #f1f1f1; text-align: left;">
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">N°</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">UBICACIÓN</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">TIPO / CAP.</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">ÚLT. RECARGA</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">PROX. RECARGA</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">ESTADO</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">VERIFICACIONES</th>
                    <th style="padding: 10px; border-bottom: 2px solid #ddd;">OBSERVACIONES</th>
                </tr>
            </thead>
            <tbody>
                {% for item in object.items.all %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px; font-weight: bold;">{{ item.extinguisher_number }}</td>
                    <td style="padding: 10px;">{{ item.location }}</td>
                    <td style="padding: 10px;">{{ item.get_extinguisher_type_display }}<br>{{ item.capacity }}</td>
                    <td style="padding: 10px;">{{ item.last_recharge_date|date:"d/m/Y"|default:"-" }}</td>
                    <td style="padding: 10px;">{{ item.next_recharge_date|date:"d/m/Y"|default:"N/A" }}</td>
                    <td style="padding: 10px;">
                        <span
                            style="font-weight: bold; color: {% if item.status == 'Bueno' %}#28a745{% elif item.status == 'Malo' %}#dc3545{% else %}#ffc107{% endif %};">
                            {{ item.status }}
                        </span>
                    </td>
                    <td style="padding: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px;">
                            <span>Manómetro: {% if item.pressure_gauge_ok %}OK{% else %}NO{% endif %}</span>
                            <span>Seguro: {% if item.safety_pin_ok %}OK{% else %}NO{% endif %}</span>
                            <span>Manguera: {% if item.hose_nozzle_ok %}OK{% else %}NO{% endif %}</span>
                            <span>Señal: {% if item.signage_ok %}OK{% else %}NO{% endif %}</span>
                        </div>
                    </td>
                    <td style="padding: 10px;">{{ item.observations|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Sección de Firmas -->
    <div style="margin-top: 50px; page-break-inside: avoid;">
        <h3 style="font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px;">
            PARTICIPANTES DE INSPECCIÓN</h3>

        <div style="display: flex; gap: 40px; flex-wrap: wrap;">
            <!-- Inspector (Siempre visible como slot, firmado o no) -->
            <div style="width: 250px; text-align: center;">
                <div
                    style="height: 120px; border-bottom: 1px solid #333; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; background: #fff;">
                    {% comment %} Buscar firma del inspector {% endcomment %}
                    {% with found=False %}
                    {% for sig in signatures %}
                    {% if sig.user == object.inspector %}
                    <img src="{{ sig.signature }}" style="max-height: 100px; max-width: 100%;" alt="Firma">
                    <!-- Hack to mark found: templates dont allow var assignment easily without custom tags, but looping is enough if we rely on empty not triggering if we output something. 
                                     Actually the 'empty' clause runs if 'signatures' list is empty. 
                                     If 'signatures' has items but NOT the inspector's, we need to handle that. 
                                -->
                    {% endif %}
                    {% endfor %}

                    {# Si el estatus es cerrado, asumimos que firmó. Si no, pendiente. #}
                    {% if object.status != 'Cerrada' and not signatures %}
                    <span style="color: #ccc; font-style: italic;">Pendiente de Firma</span>
                    {% endif %}
                    {# Mejor aun: verificar si existe firma del inspector en signatures #}
                    {% endwith %}
                </div>
                <div style="font-weight: bold; font-size: 14px;">
                    {{ object.inspector.get_full_name|default:object.inspector }}</div>
                <div style="font-size: 12px; color: #666;">{{ object.inspector_role }}</div>
                <div style="font-size: 12px; color: #666;">Inspector</div>
            </div>
        </div>
    </div>

    <!-- Botón de Volver (No imprimible) -->
    <div class="no-print" style="margin-top: 40px; text-align: center;">
        <a href="{% url 'extinguisher_detail' object.pk %}" class="btn"
            style="background: #6c757d; color: white; text-decoration: none; padding: 10px 20px; border-radius: 4px;">Volver
            al Detalle</a>
        <button onclick="window.print()" class="btn btn-primary" style="margin-left: 10px; padding: 10px 20px;">Imprimir
            / Guardar PDF</button>
    </div>

</div>

<style>
    @media print {
        .no-print {
            display: none !important;
        }

        body {
            background: white;
        }

        .report-container {
            box-shadow: none;
            margin: 0;
            padding: 0;
            max-width: 100% !important;
            border: none;
        }

        .sidebar,
        .navbar,
        header,
        footer {
            display: none !important;
        }

        .main-content {
            margin: 0;
            padding: 0;
        }
    }
</style>
{% endblock %}